\documentclass[a4paper]{article}
\usepackage[french]{babel}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{booktabs}   % For better-looking horizontal lines
\usepackage{array}      % For adjusting row spacing
\usepackage{csquotes}   % pour éviter un warning
\usepackage{graphicx}   % pour les images
\usepackage{hyperref}   % pour les références
\usepackage{float}      % pour les figures
\usepackage{amsmath}    % pour les formules mathématiques
% \usepackage{multicol}   % pour les 2 colonnes
\usepackage{subcaption} % pour les sous-figures
% \usepackage{caption}    % pour les légendes
% \usepackage{fullpage}   % mets les marges en petits 
% \usepackage{placeins}   % For     \FloatBarrier command
\usepackage{appendix}  % For appendices

\usepackage[style=ieee,backend=biber]{biblatex}
\addbibresource{ref.bib}

\hypersetup{
    colorlinks=true,
    linkcolor=blue,   % Couleur des liens internes (table des matières, références)
    citecolor=green,  % Couleur des liens vers les références bibliographiques
    filecolor=magenta,% Couleur des liens vers les fichiers
    urlcolor=blue     % Couleur des liens vers les URL
}

\title{Rapport Projet 3A \\ Analyse de traces de sang}
% \subtitle{Analyse de trace de sang}
\author{Cléa Han, Yanis Labeyrie et Adrien Zabban}
% \institute{Ecole Centrale Méditerranée, 13013 Marseille, France}
\date{Mars 2024}

\begin{document}

\maketitle
% \bigskip
% \tableofcontents
% \newpage

\section{Introduction}

Notre projet 3A s'intéresse à l'analyse de traces de sang dans le cadre du travail de l'expert criminalistique Philippe Esperança. En effet, l'objectif est de réaliser une intelligence artificielle pour assister et faciliter le travail d'analyse de scènes de crimes présentant du sang. 

Les travaux de Philippe Esperança sur l'analyse des traces de sangs~\cite{PhilippeEsperança}, a abouti à la classification de ces traces en 19 classes distinctes qui sont listées dans la Table~\ref{tab:classes}. Notre but est alors de faire un modèle de machine learning capable de prédire la classe pour une image de trace de sang.

\begin{table}[ht]
    \centering
    \begin{tabular}{|ll|}
        \hline
        \textbf{Classe des types de trace de sang} &  \\
        \hline
        1- Modèles Traces passives & 2- Modèles Goutte à Goutte \\
        3- Modèle Transfert par contact & 4- Modèle Transfert glissé \\
        5- Modèle Altération par contact & 6- Modèle Altération glissée \\
        7- Modèle d'Accumulation & 8- Modèle Coulée \\
        9- Modèle Chute de volume & 10- Modèle sang Propulsé \\
        11- Modèle d'éjection & 12- Modèle Volume Impacté \\
        13- Modèle Imprégnation & 14- Modèle Zone d'interruption \\
        15- Modèle d'impact & 16- Modèle Foyer de modèle d'impact \\
        17- Modèle Trace gravitationnelle & 18- Modèle Sang expiré \\
        19- Modèle Trace d'insecte & \\
        \hline
    \end{tabular}
    \caption{Liste des 19 modèles de trace de sang}
    \label{tab:classes}
\end{table}

\section{Données}

Philippe Esperança nous a fourni deux bases de données. La première contient des images de traces de sang reproduites en laboratoire. La deuxième correspond à des images issues de scène de crime.
Cependant, il y avait la présence d'une classe trop minoritaire parmi ces 19 classes, qui est la classe de trace d'insectes possédant uniquement quatre images. Cette classe a donc été retirée afin de garder une certaine distribution relativement équilibrée. Nous avons donc travaillé avec 18 classes.

\subsection{Données de laboratoire}

Dans un premier temps, nous avons pu manipuler des données de laboratoire, c'est-à-dire des images de traces de sang reproduites en laboratoire sur des fonds réguliers, hors des scènes de crimes. Ces fonds sont de quatre types différents : bois, linoleum (lino), carrelage et papier. Ces données sont composées de $10978$ images.
La Figure~\ref{fig: labs images} présente des images de taches de sang reproduites en laboratoire. La Table~\ref{tab: images of all classes} en annexe montre un exemple de trace de sang pour chacune des 18 classes.

\begin{figure}[ht]
    \centering
    \begin{subfigure}{0.40\linewidth}
        \centering
        \includegraphics[width=\linewidth]{../asset/data_labo/4_papier_1586.jpg}
        \caption{Modèle Transfert glissé sur un fond de papier}
    \end{subfigure}
    \begin{subfigure}{0.40\linewidth}
        \centering
        \includegraphics[width=\linewidth]{../asset/data_labo/8_coulée_4526.jpg}
        \caption{Modèle de Coulée sur fond de lino}
    \end{subfigure}
    \caption{Deux images de laboratoire}
    \label{fig: labs images}
\end{figure}

Nous avons réparti ces données de laboratoire en 80\% dans nos données d'entraînement, 10\% dans nos données de validation et 10\% dans nos données de test. La Figure~\ref{fig:distribution labo} nous montre la distribution des données de laboratoire sur chacune des classes et chacun des datasets.

\begin{figure}[ht]
    \centering
    \includegraphics[width=0.8\linewidth]{../asset/distribution_train_val_test.png}
    \caption{Distribution des données de laboratoire sur les 18 classes selon le dataset d'entraînement, de validation et de test.}
    \label{fig:distribution labo}
\end{figure}

\subsection{Données réelles issues de scènes de crime}
Après l'élaboration de nos éventuels modèles pour la problématique traitée, nous avons pu manipuler des données dites réelles. Ce sont des données prises directement sur les scènes de crimes, qui sont composées de 245 images. Les images sont alors relativement moins consistantes et plus hétérogènes que les données de laboratoire. En effet, ces images sont donc issues de prises réalisées le plus souvent par la police scientifique, qui ne prend pas en compte les conditions consistantes de prise de photo respectées dans les données de laboratoire prises par Philippe Esperança. La Figure~\ref{fig: reals images} montre des exemples d'images réelles. On peut dès maintenant s'apercevoir que ces données vont être beaucoup plus compliquées à analyser pour nos modèles de deep learning au vu des nombreux objets présents sur les photos.

\begin{figure}[ht]
    \centering
    \begin{subfigure}{0.40\linewidth}
        \centering
        \includegraphics[width=\linewidth]{../asset/data_real/12.jpg}
        \caption{Modèle Volume Impacté}
    \end{subfigure}
    \begin{subfigure}{0.40\linewidth}
        \centering
        \includegraphics[width=\linewidth]{../asset/data_real/15.jpg}
        \caption{Modèle d'impact}
    \end{subfigure}
    \caption{Deux images de scènes de crime}
    \label{fig: reals images}
\end{figure}

Nous avons réparti ces données réelles à 60\% dans nos données d'entraînement, à 10\% dans nos données de validation et à 30\% dans nos données de test. En effet, une plus grande proportion d'images a été attribuée au test des données réelles afin d'avoir un test relativement plus représentatif. Cet ensemble de données de test est composé de 73 images. La Figure~\ref{fig:distribution real} nous montre la distribution des données réelles sur chacune des classes et chacun des datasets.

\begin{figure}[ht]
    \centering
    \includegraphics[width=0.8\linewidth]{../asset/distribution_train_val_test.png}
    \caption{Distribution des données de scène de crimes selon le dataset d'entraînement, de validation et de test.}
    \label{fig:distribution real}
\end{figure}

\subsection{Data Processing}
Les images que l'on a reçues sont en couleurs et ont une taille variable allant de $2000\times2000$ à $10000\times10000$ pixels. Nous avons donc redimensionné toutes nos images en $256\times256$. Pour l'entraînement de nos modèles deep learning, nous avons fait des symétries horizontales et verticales. Nous n'avons pas fait de rotation sur les images, car Philippe Esperança nous a expliqué qu'il ne prenait que des photos en face des taches de sang (donc sans rotation). Donc il n'est pas nécessaire d'apprendre les rotations des images. Nous avons aussi joué sur le contraste et la luminescence des images. Pour la validation, le test et l'inférence, nous n'avons pas mis de data augmentation.

\section{Modèles}

Pour aborder l'analyse de traces de sang, nous avons décidé d'utiliser le modèle Resnet 50~\cite{ResNet} pré-entraîné sur ImageNet selon certains poids indiqués dans la bibliographie~\cite{torchvision}, selon diverses approches. Nous avons utilisé la crossentropy pour notre fonction de coût, et Adam~\cite{adam} pour l'optimizer.

\subsection{ResNet linear probe}
Nous avons dans un premier temps retiré la dernière couche dense du modèle, qui était destinée à classifier sur 1000 catégories, puis effectuer du linear probing. Nous avons donc gelé tous les poids du Resnet et nous avons remplacé la dernière couche dense par 2 couches denses (qui elles sont apprenables) pour avoir une dernière couche dense à 18 neurones\footnote{la sortie correspond alors aux 18 modèles de taches de sang.}. La couche dense intermédiaire est de taille 64, et nous avons fixé un dropout à $0.1$. La Figure~\ref{fig:resnet} représente ce modèle linear probe ResNet. Les modèles utilisant le linear probing seront désignés par LP Resnet dans la suite.

\begin{figure}[ht]
    \centering
    \includegraphics[width=0.7\linewidth]{../asset/Resnet.png}
    \caption{Schéma du modèle Resnet}
    \label{fig:resnet}
\end{figure}

\subsection{Réentraînement de tout le ResNet}
Nous avons également testé la méthode LP ResNet sans geler les poids de convolution du ResNet. Les modèles concernés par cette méthode seront désignés par "AWL ResNet" pour All weight learnable.

\subsection{Modèle Adversarial}

Un des points important pour la classification d'image est de pouvoir détecter la tache de sang et de la détacher du fond (background). Nous avons alors implémenté un entraînement adversarial. En plus du modèle ResNet, nous avons rajouté un modèle de MLP (Multilayer Perceptron) composé de deux couches fully connected layer qui prend en entrée la sortie de l'avant-dernière couche dense de notre Linear Probe ResNet, et prédit le background. Le but est d'alors de faire en sorte que le modèle ResNet ne possède pas d'informations sur le background de l'image dans son espace latent. La Figure~\ref{fig:resnet_adv} montre ces deux modèles. Nous appellerons cette approche "modèle Adversarial".

\begin{figure}[ht]
    \centering
    \includegraphics[width=0.7\linewidth]{../asset/Resnet_adv.png}
    \caption{Schéma du modèle Resnet adversarial}
    \label{fig:resnet_adv}
\end{figure}

Nous avons fait un entraînement adversarial pour entraîner les deux modèles simultanément. Nous avons utilisé la fonction de coût définie dans la Formule~\ref{eq: advloss}, où $CE_{tache}$ est la crossentropy entre la prédiction du modèle ResNet et la classe de la tache de sang, et $CE_{background}$ est la crossentropy de la prédiction du modèle adversarial et le background de l'image. Le paramètre $\alpha$ est un hyperparamètre que l'on va optimiser dans la section~\ref{sec: random search}.
\begin{equation}
    L_{adv} = \frac{CE_{tache}}{\alpha CE_{background}}
    \label{eq: advloss}
\end{equation}

La loss $L_{adv}$ est rétro-propagée dans le modèle ResNet tandis que la loss $CE_{background}$ est alors propagée dans le modèle adversarial.

\subsection{Fine-tune des modèles sur les données réelles}
Une fois que nous avons appris nos modèles LP ResNet et AWL ResNet sur les données de laboratoires, nous avons fine-tune ces modèles sur les données réelles (données issues de scène de crime). Nous avons appelé ces modèles respectivement FT LP Resnet et FT AWL ResNet.

Nous n'avons pas pu fine-tune le modèle Adversarial, car les taches de sang ne sont pas sur les fonds unis, et par conséquent, il n'est pas possible de fine-tune le modèle prédicteur de background sur ces données.

\section{Métriques}
Pour comparer les performances de nos modèles, nous avons utilisé les métriques suivantes : l'accuracy micro (indique le pourcentage de réussite d'un modèle), l'accuracy macro (indique la moyenne du pourcentage de réussite de chacune des classes), la précision, le rappel, le f1-score, le top~3 (indique le pourcentage de trouver la réponse parmi les 3 classes les plus prédites par le modèle). Toutes ces métriques sont des valeurs qui vont de 0 à 100, où 100 est le meilleur score. 
Les procédures de calcul de ces métriques sont explicitées en détail dans l'annexe~\ref{sec: metrics}.

\section{Apprentissage des modèles}
\input{learning}

\section{Interprétabilité}
\input{grad_cam_explanation}

\section{Résultats}

Les résultats de test sur les données de laboratoire~\ref{tab:results_lab} indiquent de meilleures performances pour le modèle Resnet qui a été réentraîné sur tous ses poids, selon l'accuracy et le F1-score. 

\begin{table}[ht]
  \centering
    \begin{tabular}{cccccc}
    \toprule
    Modèles & Acc Micro & Acc Macro & F1-score & Top 3 \\
    \midrule
    LP ResNet & 95.2 & 94.3 & 94.7 & \textbf{99.8} \\
    AWL ResNet & \textbf{97.3} & \textbf{97.1} & \textbf{96.2} & \textbf{99.8} \\
    Adversarial & 93.4 & 91.8 & 91.8 & \textbf{99.8} \\
    \bottomrule
    \end{tabular}
    \caption{Résultats de test sur les données de laboratoire}
    \label{tab:results_lab}
\end{table}

Les résultats de test sur les données de laboratoire~\ref{tab: results_real} indiquent de meilleures performances pour le modèle Resnet qui était entraîné entièrement sur les données de laboratoire, puis fine-tuné sur les données réelles, selon l'accuracy et le F1-score. 

\begin{table}[ht]
  \centering
    \begin{tabular}{ccccccc}
    \toprule
    Modèles & Acc Micro & Acc Macro & F1-score & Top 3 \\
    \midrule
    LP ResNet & 12.9 & 6.0 & 4.0 & 19.0 \\
    FT LP ResNet & 11.8 & 6.1 & 6.4 & 26.0 \\
    AWL Resnet & 17.2 & 13.8 & 8.1 & 28.7 \\
    FT AWL ResNet & \textbf{41.9} & \textbf{33.4} & \textbf{26.9} & \textbf{51.7} \\
    Adversarial & 11.8 & 5.7 & 3.7 & 16.7 \\
    \bottomrule
    \end{tabular}
    \caption{Résultats de test sur les données réelles}
    \label{tab: results_real}
\end{table}

\section{Conclusion}

Notre projet s'inscrit dans une volonté d'optimiser le travail d'analyse de traces de sang en criminologie, notamment pour l'expert international Philippe Esperança. 
Nous avons aussi testé d'autres méthode que nous avons détaillées dans la section~\ref{sec: pistes infructruces}.

En effet, notre encadrant a pu recevoir notre projet sous la forme d'une interface qui fonctionne localement sur son appareil de travail. En effet, ce modèle d'analyse de traces de sang ne doit pas avoir accès à internet afin d'éviter tout risque d'attaque ou de fuite de données. Pouvoir faire tourner le projet en local pour l'expert criminalistique lui permet de nous faire confiance vis-à-vis de l'outil implémenté. Il a pu apprécier et être satisfait de notre rendu.

Notre projet fait également l'objet d'une documentation afin qu'il puisse être repris aisément à l'avenir. 

\printbibliography

% \newpage
\begin{appendices}

\section{Images de laboratoire}
\label{sec: annexe}

\begin{table}[H]
    \centering
    \begin{tabular}{ccc}
        % \hline
        \includegraphics[width=0.20\linewidth]{../asset/data_labo/1_bois_350.jpg} & \includegraphics[width=0.20\linewidth]{../asset/data_labo/2_carrelage_523.jpg}& \includegraphics[width=0.20\linewidth]{../asset/data_labo/3_lino_888.jpg} \\
        1- Traces passives & 2- Goutte à Goutte & 3- Transfert par contact \\
        % \hline
        \includegraphics[width=0.20\linewidth]{../asset/data_labo/4_papier_1586.jpg} & \includegraphics[width=0.20\linewidth]{../asset/data_labo/5_carrelage_5605.jpg} & \includegraphics[width=0.20\linewidth]{../asset/data_labo/6_bois_604.jpg} \\
        4- Transfert glissé & 5- Altération par contact & 6- Altération glissée \\
        % \hline
        \includegraphics[width=0.20\linewidth]{../asset/data_labo/7_carrelage_5507.jpg} & \includegraphics[width=0.20\linewidth]{../asset/data_labo/8_coulée_4526.jpg} & \includegraphics[width=0.20\linewidth]{../asset/data_labo/9_papier_6375.jpg} \\
        7- Accumulation & 8- Coulée & 9- Chute de volume \\
        % \hline
        \includegraphics[width=0.20\linewidth]{../asset/data_labo/10_lino_933.jpg} & \includegraphics[width=0.20\linewidth]{../asset/data_labo/11_carrelage_905.jpg} & \includegraphics[width=0.20\linewidth]{../asset/data_labo/12_bois_326.jpg} \\
        10- Sang Propulsé & 11- éjection & 12- Volume impacté \\
        % \hline
        \includegraphics[width=0.20\linewidth]{../asset/data_labo/13_carrelage_7374.jpg} & \includegraphics[width=0.20\linewidth]{../asset/data_labo/14_lino_6320.jpg} & \includegraphics[width=0.20\linewidth]{../asset/data_labo/15_p1040.jpg} \\
        13- Imprégnation & 14- Zone d'interruption & 15- Modèle d'impact \\
        % \hline
        \includegraphics[width=0.20\linewidth]{../asset/data_labo/16_carrelage_598.jpg} & \includegraphics[width=0.20\linewidth]{../asset/data_labo/17_papier_8323.jpg} & \includegraphics[width=0.20\linewidth]{../asset/data_labo/18_bois_4727.jpg}\\
        16- Foyer de modèle d'impact & 17- Trace gravitationnelle & 18- Sang expiré \\
        % \hline
    \end{tabular}
    \caption{Classe des données de laboratoire et leur exemple en image}
    \label{tab: images of all classes}
\end{table}

\section{Calcul des métriques}
\label{sec: metrics}
\input{metrics}

\section{Pistes infructueuses}
\label{sec: pistes infructruces}
\input{pistes_infructueuses}


\end{appendices}

\end{document}
